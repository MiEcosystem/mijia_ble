<!DOCTYPE html>
<!-- saved from url=(0077)https://wiki.n.miui.com/plugins/viewsource/viewpagesrc.action?pageId=70115818 -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>View Source</title>
        <link rel="canonical" href="https://wiki.n.miui.com/pages/viewpage.action?pageId=$action.page.id">
        <script>
window.WRM=window.WRM||{};window.WRM._unparsedData=window.WRM._unparsedData||{};window.WRM._unparsedErrors=window.WRM._unparsedErrors||{};
WRM._unparsedData["com.atlassian.plugins.atlassian-plugins-webresource-plugin:context-path.context-path"]="\u0022\u0022";
if(window.WRM._dataArrived)window.WRM._dataArrived();</script>
<link type="text/css" rel="stylesheet" href="./index_files/batch.css" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<!--[if lt IE 9]>
<link type="text/css" rel="stylesheet" href="/s/51f05e6de629128772c5537e002a7369-CDN/en_GB/7502/340b75d71415eda8adf77a2ec8189dfe8b18deb1/005b7fef6334f1adac91bdf89df365a5/_/download/contextbatch/css/_super/batch.css?conditionalComment=lt+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/51f05e6de629128772c5537e002a7369-CDN/en_GB/7502/340b75d71415eda8adf77a2ec8189dfe8b18deb1/005b7fef6334f1adac91bdf89df365a5/_/download/contextbatch/css/_super/batch.css?conditionalComment=lte+IE+9" data-wrm-key="_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="./index_files/batch(1).css" data-wrm-key="plugin.viewsource,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./index_files/batch(2).css" data-wrm-key="page,-_super" data-wrm-batch-type="context" media="all">
<link type="text/css" rel="stylesheet" href="./index_files/batch(3).css" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<!--[if lte IE 9]>
<link type="text/css" rel="stylesheet" href="/s/c9b6512fe2bd6ba952842e488ce0470d-CDN/en_GB/7502/340b75d71415eda8adf77a2ec8189dfe8b18deb1/316fd884377158e1463a733e3468e6cd/_/download/contextbatch/css/editor-content,-_super/batch.css?conditionalComment=lte+IE+9&amp;confluence.table.resizable=true&amp;confluence.view.edit.transition=true" data-wrm-key="editor-content,-_super" data-wrm-batch-type="context" media="all">
<![endif]-->
<link type="text/css" rel="stylesheet" href="./index_files/custom.css" media="all">

    </head>

    <body class="mceContentBody aui-theme-default wiki-content fullsize">
        <p>&nbsp;</p>         <h2>米家蓝牙标准认证库说明</h2><hr><p>mible_std_authen库是接入米家的蓝牙设备与米家app之间标准认证库，用于普通安全等级的设备接入米家APP，各个平台实现demo见</p><p><a href="https://github.com/MiEcosystem/mijia_ble.git" style="text-decoration: underline;text-align: left;">https://github.com/MiEcosystem/mijia_ble.git</a></p><p>demo中功能实现均基于米家通用API，详见</p><p><span style="color: rgb(51,51,51);text-decoration: none;"> </span><a href="https://github.com/MiEcosystem/mijia_ble_api.git" style="text-decoration: underline;text-align: left;">https://github.com/MiEcosystem/mijia_ble_api.git</a></p><p>米家认证功能均封装在mible_std_authen_xxxx.lib 库中，通过在蓝牙设备端建立Mi Service服务，实现设备和米家APP相互认证。认证初始化及相关接口功能如下：</p><table class="wrapped confluenceTable"><colgroup><col><col><col></colgroup><tbody><tr><th class="confluenceTh"><p>函数名</p></th><th class="confluenceTh"><p>功能</p></th><th class="confluenceTh"><p>说明</p></th></tr><tr><td class="confluenceTd"><p>mible_server_info_init</p></td><td class="confluenceTd"><p>初始化设备信息</p></td><td class="confluenceTd"><p>初始化设备参数：</p><p>1、绑定关系（强/弱），需与米家开放平台上强弱<span>绑定</span><span>配置</span>一致</p><p>2、产品ID，需与米家开放平台上产品ID配置一致</p><p>3、版本号（四位数字字符如”1234”）</p><p>4、是否需要绑定确认（例如按键、敲击等），如需要确认，配合<span style="color: rgb(51,51,51);text-decoration: none;">mible_std_auth_permit_bind</span>和<span style="color: rgb(51,51,51);text-decoration: none;">mible_std_auth_forbid_bind</span>使用；如不需要则随时可进行绑定</p><p>5、设备模式，如产品为遥控器则选择MODE_REMOTE，否则选MODE_STANDARD</p></td></tr><tr><td colspan="1" class="confluenceTd">mible_std_auth_permit_bind</td><td colspan="1" class="confluenceTd">允许设备绑定</td><td colspan="1" class="confluenceTd">应用层允许设备进入待绑定状态（例如用户按键、敲击设备）</td></tr><tr><td colspan="1" class="confluenceTd">mible_std_auth_forbid_bind</td><td colspan="1" class="confluenceTd">禁止设备绑定</td><td colspan="1" class="confluenceTd">应用层禁止<span style="color: rgb(51,51,51);text-decoration: none;">设备绑定（例如由超时事件触发）</span></td></tr><tr><td class="confluenceTd"><p>mible_server_miservice_init</p></td><td class="confluenceTd"><p>初始化MiService</p></td><td class="confluenceTd"><p>用于初始化MiService，在初始化阶段调用</p></td></tr><tr><td colspan="1" class="confluenceTd">mible_std_auth_evt_register</td><td colspan="1" class="confluenceTd">注册回调函数</td><td colspan="1" class="confluenceTd">用于向米家认证流程注册回调函数，在回调函数中可接收事件，例如连接、断开、service初始化完成、绑定结果</td></tr><tr><td colspan="1" class="confluenceTd">mible_std_server_encrypt</td><td colspan="1" class="confluenceTd">数据加密</td><td colspan="1" class="confluenceTd">米家认证流程中可生成密钥（设备与米家APP共享），使用该密钥加密数据</td></tr><tr><td colspan="1" class="confluenceTd">mible_std_server_decrypt</td><td colspan="1" class="confluenceTd">数据解密</td><td colspan="1" class="confluenceTd">使用密钥解密数据</td></tr><tr><td colspan="1" class="confluenceTd">mible_std_auth_factory_reset</td><td colspan="1" class="confluenceTd">将设备恢复至出厂状态</td><td colspan="1" class="confluenceTd">删除米家认证相关数据，将设备恢复至出厂状态</td></tr></tbody></table><p>此外在mible_server.h文件中，还有一些参数可供应用层修改：</p><table class="relative-table wrapped confluenceTable" style="width: 33.0225%;"><colgroup><col style="width: 56.0732%;"><col style="width: 43.9268%;"></colgroup><tbody><tr><th class="confluenceTh">宏定义</th><th class="confluenceTh">说明</th></tr><tr><td class="confluenceTd">MIBLE_STD_SERVER_CONN_MAX_INTERVAL</td><td class="confluenceTd">最大连接间隔</td></tr><tr><td class="confluenceTd">MIBLE_STD_SERVER_CONN_MIN_INTERVAL</td><td class="confluenceTd">最小连接间隔</td></tr><tr><td colspan="1" class="confluenceTd">MIBLE_STD_SERVER_CONN_SLAVE_LATENCY</td><td colspan="1" class="confluenceTd">从设备连接延迟</td></tr><tr><td colspan="1" class="confluenceTd">MIBLE_STD_SERVER_CONN_SUP_TIMEOUT</td><td colspan="1" class="confluenceTd">连接超时时间</td></tr></tbody></table><h2>调用实例</h2><hr><p>Demo中展示了如何使用米家蓝牙标准认证库，具体使用流程如下：</p><ol><li>完成必要的初始化工作，如蓝牙协议栈初始化、flash记录初始化、timer初始化等，使得米家通用蓝牙接口可以正常工作</li><li><span>调用&nbsp;<span>mible_server_info_init 函数，完成产品信息的初始化配置</span></span></li><li><span><span>调用 mible_server_miservice_init 函数，初始化用于米家认证 Service 和 characteristic（Service UUID 0xFE95）</span></span></li><li>广播 mibeacon（定义见<a href="https://github.com/MiEcosystem/miio_open/blob/master/ble/03-%E7%B1%B3%E5%AE%B6BLE%E5%B9%BF%E6%92%AD%E5%8D%8F%E8%AE%AE.md">https://github.com/MiEcosystem/miio_open/blob/master/ble/03-米家BLE广播协议.md</a>）</li></ol><p><span style="color: rgb(51,51,51);text-decoration: none;">mibeacon是小米定义的广播包格式，用处主要有两个：</span></p><ol><li><span style="color: rgb(51,51,51);text-decoration: none;">米家APP通过mibeacon发现设备，并显示到设备列表中</span></li><li><span style="color: rgb(51,51,51);text-decoration: none;">设备通过设置mibeacon中的object信息，可以被蓝牙网关扫描并上报</span></li></ol><p>相关API实现见</p><p><span style="color: rgb(3,47,98);text-decoration: none;"><a href="https://github.com/MiEcosystem/mijia_ble_common.git">https://github.com/MiEcosystem/mijia_ble_common.git</a></span></p><p>运行认证库的蓝牙设备为slave，当手机米家app扫描到mibeacon，可以作为master发起连接蓝牙设备，一旦建立连接会触发认证流程。 当设备第一次建立连接时，触发绑定流程。若绑定成功，则此后建立连接都会触发<span>登录</span>流程。建立连接后，若未成功进行绑定或登陆，超时10s后会自动断开连接，认证库通过注册的回调函数通知应用层执行结果。在绑定成功后，会将设备认证的相关信息存储在flash中（如果flash存储不成功会导致此后的的登录流程不成功）。</p><h2>FAQ</h2><hr><p>1.需要设备端确认的产品，该如何调用？</p><p>答：&nbsp;对于需要设备确认的认证过程(如蓝牙温湿度传感器，用户需要按键确定是哪个设备需要被绑定) ，开发者要注意mibeacon中bindingcfm位的使用。正常广播的mibeacon中bindingcfm位为0，当用户触发，如按键，mibeacon中bindingcfm位变为1，持续2~3秒后恢复为0。此时手机可以发现此设备并连接开始认证流程。</p><p>2. 产品的pid如何获取？</p><p>答：产品的pid是在开放平台上注册产品时生成的，在demo中 pid = 156 ，是一个弱绑定的蓝牙开发板产品，用于测试。 还有一个强绑定的蓝牙开发板 产品pid = 930，此两个产品类型仅用于开发者做初期测试。在真正的产品开发中，开发者应需要pid 及强弱绑定关系，与在米家开放平台上注册产品时的信息保持一致。</p>
        <p>&nbsp;</p>
    

</body></html>